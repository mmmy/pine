// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© gouge99 (Modified by Gemini)

//@version=5
indicator("MT5 Indicator (Multi-Level, Final 3, 20 Sessions)", overlay=true, max_labels_count = 500)

// =============================================================================
// äº¤æ˜“è®¾ç½®
// =============================================================================
tradingGroup = 'äº¤æ˜“è®¾ç½®'
tradingDirection = input.string("åšå¤š", "è­¦æŠ¥æ–¹å‘", options=["åšå¤š", "åšç©º"], group=tradingGroup, tooltip="æ­¤é€‰é¡¹ä»…è¿‡æ»¤è­¦æŠ¥ï¼Œå›¾è¡¨ä¸Šä¼šæ˜¾ç¤ºæ‰€æœ‰ä¿¡å·")
minBodySize = input.float(1.0, "æœ€å°å®ä½“é•¿åº¦", group=tradingGroup, tooltip="é€‚ç”¨äºæ‰€æœ‰ä¿¡å·çš„æœ€å°Kçº¿å®ä½“é•¿åº¦")
positionMode = input.string('è´§å¸æ•°', title = 'ä»“ä½æ¨¡å¼', options = ["è´§å¸æ•°", "åˆçº¦æ•°"])

// --- çººé”¤çº¿ä¿¡å·è®¾ç½® ---
spinningTopGroup = "çººé”¤çº¿ä¿¡å·è®¾ç½®"
enableSpinningTopSignal = input.bool(true, "å¯ç”¨çººé”¤çº¿ä¿¡å·", group=spinningTopGroup)
positionSize_Spin = input.float(1.0, "å¼€ä»“æ•°é‡", minval=0.01, group=spinningTopGroup)
enableSpinningTopPriceCheck = input.bool(false, "å¯ç”¨å¼€ç›˜ä»·æ¯”è¾ƒæ¡ä»¶", group=spinningTopGroup, tooltip="åšå¤šï¼šå¼€ç›˜ä»· > ç™½è‰²çººé”¤çº¿æ”¶ç›˜ä»·ï¼›åšç©ºï¼šå¼€ç›˜ä»· < é»‘è‰²çººé”¤çº¿æ”¶ç›˜ä»·")

// --- ä»·æ ¼æˆäº¤æ¡ä»¶ 1 ---
level1Group = "ä»·æ ¼æˆäº¤æ¡ä»¶ 1"
enable_L1 = input.bool(true, "å¯ç”¨", group = level1Group, inline = "L1")
price_L1 = input.price(0.0, "æˆäº¤ä»·æ ¼", group = level1Group, inline = "L1", tooltip = "ä»·æ ¼å¤§äº0æ‰ç”Ÿæ•ˆ")
size_L1 = input.float(1.0, "å¼€ä»“æ•°é‡", minval=0.01, group = level1Group, inline = "L1")

// --- ä»·æ ¼æˆäº¤æ¡ä»¶ 2 ---
level2Group = "ä»·æ ¼æˆäº¤æ¡ä»¶ 2"
enable_L2 = input.bool(false, "å¯ç”¨", group = level2Group, inline = "L2")
price_L2 = input.price(0.0, "æˆäº¤ä»·æ ¼", group = level2Group, inline = "L2", tooltip = "ä»·æ ¼å¤§äº0æ‰ç”Ÿæ•ˆ")
size_L2 = input.float(1.0, "å¼€ä»“æ•°é‡", minval=0.01, group = level2Group, inline = "L2")

// --- ä»·æ ¼æˆäº¤æ¡ä»¶ 3 ---
level3Group = "ä»·æ ¼æˆäº¤æ¡ä»¶ 3"
enable_L3 = input.bool(false, "å¯ç”¨", group = level3Group, inline = "L3")
price_L3 = input.price(0.0, "æˆäº¤ä»·æ ¼", group = level3Group, inline = "L3", tooltip = "ä»·æ ¼å¤§äº0æ‰ç”Ÿæ•ˆ")
size_L3 = input.float(1.0, "å¼€ä»“æ•°é‡", minval=0.01, group = level3Group, inline = "L3")


// =============================================================================
// æ—¶é—´è®¾ç½®
// =============================================================================
timeGroup = 'æ—¶é—´è®¾ç½®'
resistanceStartTime = input.time(timestamp("2025-07-15 00:00:00"), "ä»·æ ¼æ¡ä»¶å¼€å§‹æ—¶é—´", group=timeGroup, tooltip="æ§åˆ¶ä»·æ ¼æ¡ä»¶ä¿¡å·çš„èµ·å§‹æ—¶é—´ï¼Œçººé”¤çº¿ä¿¡å·ä¸å—æ­¤é™åˆ¶")
timezone = input.string("GMT+8", "æ—¶åŒº", options=["GMT-12", "GMT-11", "GMT-10", "GMT-9", "GMT-8", "GMT-7", "GMT-6", "GMT-5", "GMT-4", "GMT-3", "GMT-2", "GMT-1", "GMT+0", "GMT+1", "GMT+2", "GMT+3", "GMT+4", "GMT+5", "GMT+6", "GMT+7", "GMT+8", "GMT+9", "GMT+10", "GMT+11", "GMT+12"], group=timeGroup)
enableSession1 = input.bool(true, "å¯ç”¨", group=timeGroup, inline="session1")
timeSession1 = input.session("0800-1200", "äº¤æ˜“æ—¶é—´æ®µ 1", group=timeGroup, inline="session1")
enableSession2 = input.bool(true, "å¯ç”¨", group=timeGroup, inline="session2")
timeSession2 = input.session("1300-1700", "äº¤æ˜“æ—¶é—´æ®µ 2", group=timeGroup, inline="session2")
enableSession3 = input.bool(true, "å¯ç”¨", group=timeGroup, inline="session3")
timeSession3 = input.session("1900-2300", "äº¤æ˜“æ—¶é—´æ®µ 3", group=timeGroup, inline="session3")
enableSession4 = input.bool(true, "å¯ç”¨", group=timeGroup, inline="session4")
timeSession4 = input.session("0000-0600", "äº¤æ˜“æ—¶é—´æ®µ 4", group=timeGroup, inline="session4")
enableSession5 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session5")
timeSession5 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 5", group=timeGroup, inline="session5")
enableSession6 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session6")
timeSession6 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 6", group=timeGroup, inline="session6")
enableSession7 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session7")
timeSession7 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 7", group=timeGroup, inline="session7")
enableSession8 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session8")
timeSession8 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 8", group=timeGroup, inline="session8")
enableSession9 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session9")
timeSession9 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 9", group=timeGroup, inline="session9")
enableSession10 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session10")
timeSession10 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 10", group=timeGroup, inline="session10")
enableSession11 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session11")
timeSession11 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 11", group=timeGroup, inline="session11")
enableSession12 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session12")
timeSession12 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 12", group=timeGroup, inline="session12")
enableSession13 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session13")
timeSession13 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 13", group=timeGroup, inline="session13")
enableSession14 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session14")
timeSession14 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 14", group=timeGroup, inline="session14")
enableSession15 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session15")
timeSession15 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 15", group=timeGroup, inline="session15")
enableSession16 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session16")
timeSession16 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 16", group=timeGroup, inline="session16")
enableSession17 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session17")
timeSession17 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 17", group=timeGroup, inline="session17")
enableSession18 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session18")
timeSession18 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 18", group=timeGroup, inline="session18")
enableSession19 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session19")
timeSession19 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 19", group=timeGroup, inline="session19")
enableSession20 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session20")
timeSession20 = input.session("0000-0000", "äº¤æ˜“æ—¶é—´æ®µ 20", group=timeGroup, inline="session20")


// =============================================================================
// æ˜¾ç¤ºè®¾ç½®
// =============================================================================
infoLabal = 'æ˜¾ç¤ºè®¾ç½®'
showSpinInfo = input.bool(false, title = 'æ˜¾ç¤ºçººé”¤çº¿', group = infoLabal)
label_color_neutral = input(color.gray, "Label Color Neutral", group = infoLabal)
showTimeBackground = input.bool(false, "æ˜¾ç¤ºæœ‰æ•ˆæ—¶é—´åŒºé—´èƒŒæ™¯", group = infoLabal)
showPriceLevelLines = input.bool(true, "æ˜¾ç¤ºä»·æ ¼æ¡ä»¶çº¿", group = infoLabal)
showStrategyNotice = input.bool(true, "æ˜¾ç¤ºæŒ‡æ ‡ä¿¡æ¯è¡¨æ ¼", group = infoLabal)


// =============================================================================
// æ ¸å¿ƒè®¡ç®—
// =============================================================================

// --- çŠ¶æ€å˜é‡ ---
var bool longSignalTriggeredInCycle = false
var bool shortSignalTriggeredInCycle = false
var longConditionCount = array.new_int(3, 0)
var shortConditionCount = array.new_int(3, 0)

// --- çººé”¤çº¿è®¡ç®— ---
C_Len = 14
C_DojiBodyPercent = 5.0
C_BodyHi = math.max(close, open)
C_BodyLo = math.min(close, open)
C_Body = C_BodyHi - C_BodyLo
C_WhiteBody = open < close
C_BlackBody = open > close
C_Range = high-low
C_UpShadow = high - C_BodyHi
C_DnShadow = C_BodyLo - low
C_IsDojiBody = C_Range > 0 and C_Body <= C_Range * C_DojiBodyPercent / 100
C_IsSpinningTop = C_DnShadow >= C_Range / 100 * 34.0 and C_UpShadow >= C_Range / 100 * 34.0 and not C_IsDojiBody
C_SpinningTopWhite = C_IsSpinningTop and C_WhiteBody
C_SpinningTopBlack = C_IsSpinningTop and C_BlackBody

atrOffset = ta.atr(30) * 0.6

if showSpinInfo and C_SpinningTopWhite
    label.new(bar_index, low - atrOffset, text="STW", style=label.style_label_up, color = label_color_neutral, textcolor=color.white, tooltip = "ç™½è‰²çººé”¤çº¿")
if showSpinInfo and C_SpinningTopBlack
    label.new(bar_index, low - atrOffset, text="STB", style=label.style_label_up, color = label_color_neutral, textcolor=color.white, tooltip = "é»‘è‰²çººé”¤çº¿")

if C_SpinningTopWhite or C_SpinningTopBlack
    longSignalTriggeredInCycle := false
    shortSignalTriggeredInCycle := false

bsSTW = ta.barssince(C_SpinningTopWhite)
bsTTB = ta.barssince(C_SpinningTopBlack)
var float whiteSpinClosePrice = na
var float blackSpinClosePrice = na
if C_SpinningTopWhite
    whiteSpinClosePrice := close
if C_SpinningTopBlack
    blackSpinClosePrice := close

// --- æ—¶é—´æ¡ä»¶æ£€æŸ¥ ---
isInTradingSession() =>
    session1 = enableSession1 ? time(timeframe.period, timeSession1, timezone) : na
    session2 = enableSession2 ? time(timeframe.period, timeSession2, timezone) : na
    session3 = enableSession3 ? time(timeframe.period, timeSession3, timezone) : na
    session4 = enableSession4 ? time(timeframe.period, timeSession4, timezone) : na
    session5 = enableSession5 ? time(timeframe.period, timeSession5, timezone) : na
    session6 = enableSession6 ? time(timeframe.period, timeSession6, timezone) : na
    session7 = enableSession7 ? time(timeframe.period, timeSession7, timezone) : na
    session8 = enableSession8 ? time(timeframe.period, timeSession8, timezone) : na
    session9 = enableSession9 ? time(timeframe.period, timeSession9, timezone) : na
    session10 = enableSession10 ? time(timeframe.period, timeSession10, timezone) : na
    session11 = enableSession11 ? time(timeframe.period, timeSession11, timezone) : na
    session12 = enableSession12 ? time(timeframe.period, timeSession12, timezone) : na
    session13 = enableSession13 ? time(timeframe.period, timeSession13, timezone) : na
    session14 = enableSession14 ? time(timeframe.period, timeSession14, timezone) : na
    session15 = enableSession15 ? time(timeframe.period, timeSession15, timezone) : na
    session16 = enableSession16 ? time(timeframe.period, timeSession16, timezone) : na
    session17 = enableSession17 ? time(timeframe.period, timeSession17, timezone) : na
    session18 = enableSession18 ? time(timeframe.period, timeSession18, timezone) : na
    session19 = enableSession19 ? time(timeframe.period, timeSession19, timezone) : na
    session20 = enableSession20 ? time(timeframe.period, timeSession20, timezone) : na
    not na(session1) or not na(session2) or not na(session3) or not na(session4) or not na(session5) or not na(session6) or not na(session7) or not na(session8) or not na(session9) or not na(session10) or not na(session11) or not na(session12) or not na(session13) or not na(session14) or not na(session15) or not na(session16) or not na(session17) or not na(session18) or not na(session19) or not na(session20)

bgcolor(showTimeBackground and isInTradingSession() ? color.new(color.blue, 95) : na)

isLastTenMinutes() => minute(time) >= 50
priceLevelTimeCondition = isInTradingSession() and not isLastTenMinutes() and time >= resistanceStartTime
spinningTimeConditionMet = isInTradingSession() and not isLastTenMinutes()

// --- äº¤æ˜“æ¡ä»¶åˆ¤æ–­ ---

// - çººé”¤çº¿æ¡ä»¶
isAfterWhiteSpinBeforeBlack = bsSTW < bsTTB or (bsSTW >= 0 and na(bsTTB))
isAfterBlackSpinBeforeWhite = bsTTB < bsSTW or (bsTTB >= 0 and na(bsSTW))

longCondition_Spin = false
if enableSpinningTopSignal and isAfterWhiteSpinBeforeBlack and not C_SpinningTopBlack and not longSignalTriggeredInCycle
    hasNoLowerShadow = open == low
    priceCondition = enableSpinningTopPriceCheck ? (not na(whiteSpinClosePrice) and open > whiteSpinClosePrice) : true
    longCondition_Spin := C_WhiteBody and C_Body >= minBodySize and hasNoLowerShadow and spinningTimeConditionMet and priceCondition
if longCondition_Spin
    longSignalTriggeredInCycle := true

shortCondition_Spin = false
if enableSpinningTopSignal and isAfterBlackSpinBeforeWhite and not C_SpinningTopWhite and not shortSignalTriggeredInCycle
    hasNoUpperShadow = open == high
    priceCondition = enableSpinningTopPriceCheck ? (not na(blackSpinClosePrice) and open < blackSpinClosePrice) : true
    shortCondition_Spin := C_BlackBody and C_Body >= minBodySize and hasNoUpperShadow and spinningTimeConditionMet and priceCondition
if shortCondition_Spin
    shortSignalTriggeredInCycle := true

// - ä»·æ ¼æˆäº¤æ¡ä»¶
longCondition_L1 = false
longCondition_L2 = false
longCondition_L3 = false
shortCondition_L1 = false
shortCondition_L2 = false
shortCondition_L3 = false

// Level 1 Logic
if enable_L1 and price_L1 > 0 and priceLevelTimeCondition
    if array.get(longConditionCount, 0) == 0
        if C_WhiteBody and C_Body >= minBodySize and (open == low) and (open < price_L1 and (close - price_L1) / C_Body > 2/3)
            longCondition_L1 := true
            array.set(longConditionCount, 0, 1)
    if array.get(shortConditionCount, 0) == 0
        if C_BlackBody and C_Body >= minBodySize and (open == high) and (open > price_L1 and (price_L1 - close) / C_Body > 2/3)
            shortCondition_L1 := true
            array.set(shortConditionCount, 0, 1)

// Level 2 Logic
if enable_L2 and price_L2 > 0 and priceLevelTimeCondition
    if array.get(longConditionCount, 1) == 0
        if C_WhiteBody and C_Body >= minBodySize and (open == low) and (open < price_L2 and (close - price_L2) / C_Body > 2/3)
            longCondition_L2 := true
            array.set(longConditionCount, 1, 1)
    if array.get(shortConditionCount, 1) == 0
        if C_BlackBody and C_Body >= minBodySize and (open == high) and (open > price_L2 and (price_L2 - close) / C_Body > 2/3)
            shortCondition_L2 := true
            array.set(shortConditionCount, 1, 1)

// Level 3 Logic
if enable_L3 and price_L3 > 0 and priceLevelTimeCondition
    if array.get(longConditionCount, 2) == 0
        if C_WhiteBody and C_Body >= minBodySize and (open == low) and (open < price_L3 and (close - price_L3) / C_Body > 2/3)
            longCondition_L3 := true
            array.set(longConditionCount, 2, 1)
    if array.get(shortConditionCount, 2) == 0
        if C_BlackBody and C_Body >= minBodySize and (open == high) and (open > price_L3 and (price_L3 - close) / C_Body > 2/3)
            shortCondition_L3 := true
            array.set(shortConditionCount, 2, 1)

// --- ç»˜å›¾ ---
canLong = tradingDirection == "åšå¤š"
canShort = tradingDirection == "åšç©º"

// ç»˜åˆ¶ä»·æ ¼çº¿
if showPriceLevelLines and time >= resistanceStartTime
    if enable_L1 and price_L1 > 0
        line.new(bar_index-1, price_L1, bar_index, price_L1, color=color.new(color.red, 50), style=line.style_dashed, width=1)
    if enable_L2 and price_L2 > 0
        line.new(bar_index-1, price_L2, bar_index, price_L2, color=color.new(color.orange, 50), style=line.style_dashed, width=1)
    if enable_L3 and price_L3 > 0
        line.new(bar_index-1, price_L3, bar_index, price_L3, color=color.new(color.yellow, 50), style=line.style_dashed, width=1)

// ç»˜åˆ¶ä¿¡å·æ ‡ç­¾
plotshape(canLong and (longCondition_L1 or longCondition_L2 or longCondition_L3), title="ä»·æ ¼åšå¤š", location=location.belowbar, color=color.green, style=shape.labelup, text="ä»·å¤š", textcolor=color.white, size=size.small)
plotshape(canLong and longCondition_Spin, title="çººé”¤çº¿åšå¤š", location=location.belowbar, color=color.lime, style=shape.labelup, text="çººå¤š", textcolor=color.white, size=size.small)
plotshape(canShort and (shortCondition_L1 or shortCondition_L2 or shortCondition_L3), title="ä»·æ ¼åšç©º", location=location.abovebar, color=color.red, style=shape.labeldown, text="ä»·ç©º", textcolor=color.white, size=size.small)
plotshape(canShort and shortCondition_Spin, title="çººé”¤çº¿åšç©º", location=location.abovebar, color=color.maroon, style=shape.labeldown, text="çººç©º", textcolor=color.white, size=size.small)


format_msg(isLong, pos, msg) =>
    p = positionMode == 'è´§å¸æ•°' ? pos / close : pos
    str.format('{0} {1} ä»“ä½={2} å¤‡æ³¨={3}', isLong ? "åšå¤š" : 'åšç©º', syminfo.ticker, p, msg)

if canLong
    if longCondition_Spin
        alert(format_msg(true, positionSize_Spin, 'çººé”¤çº¿åšå¤š'))
    if longCondition_L1
        alert(format_msg(true, size_L1, 'ä»·æ ¼æ¡ä»¶åšå¤š1'))
    if longCondition_L2
        alert(format_msg(true, size_L2, 'ä»·æ ¼æ¡ä»¶åšå¤š2'))
    if longCondition_L3
        alert(format_msg(true, size_L3, 'ä»·æ ¼æ¡ä»¶åšå¤š3'))

if canShort
    if shortCondition_Spin
        alert(format_msg(false, positionSize_Spin, 'çººé”¤çº¿åšç©º'))
    if shortCondition_L1
        alert(format_msg(false, size_L1, 'ä»·æ ¼æ¡ä»¶åšç©º1'))
    if shortCondition_L2
        alert(format_msg(false, size_L2, 'ä»·æ ¼æ¡ä»¶åšç©º2'))
    if shortCondition_L3
        alert(format_msg(false, size_L3, 'ä»·æ ¼æ¡ä»¶åšç©º3'))

// åšå¤šè­¦æŠ¥æ¡ä»¶
// alertcondition(condition=canLong and longCondition_Spin, title="çººé”¤çº¿åšå¤š (Spinning Top Long)", message="long")
// alertcondition(condition=canLong and (longCondition_L1 or longCondition_L2 or longCondition_L3), title="ä»·æ ¼æ¡ä»¶åšå¤š (Price Level 1 Long)", message="long")

// åšç©ºè­¦æŠ¥æ¡ä»¶
// alertcondition(condition=canShort and shortCondition_Spin, title="çººé”¤çº¿åšç©º (Spinning Top Short)", message="short")
// alertcondition(condition=canShort and (shortCondition_L1 or shortCondition_L2 or shortCondition_L3), title="ä»·æ ¼æ¡ä»¶åšç©º (Price Level 1 Short)", message="short")


// --- æŒ‡æ ‡ä¿¡æ¯è¡¨æ ¼ ---
var table indicatorTable = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
if barstate.islast and showStrategyNotice
    table.cell(indicatorTable, 0, 0, "æŒ‡æ ‡ä¿¡æ¯", text_color=color.black, bgcolor=color.gray)
    table.cell(indicatorTable, 1, 0, "", text_color=color.black, bgcolor=color.gray)
    table.cell(indicatorTable, 0, 1, "å½“å‰çŠ¶æ€", text_color=color.black)
    table.cell(indicatorTable, 1, 1, "ç­‰å¾…æ‰€æœ‰ä¿¡å·", text_color=color.blue)
    table.cell(indicatorTable, 0, 2, "è­¦æŠ¥æ–¹å‘", text_color=color.black)
    directionColor = tradingDirection == "åšå¤š" ? color.green : color.red
    table.cell(indicatorTable, 1, 2, tradingDirection, text_color=directionColor)
    table.cell(indicatorTable, 0, 3, "ä½¿ç”¨è¯´æ˜", text_color=color.black, bgcolor=color.new(color.blue, 90))
    table.cell(indicatorTable, 1, 3, "ğŸ“ˆ å›¾è¡¨æ˜¾ç¤ºæ‰€æœ‰ä¿¡å·\nâš ï¸ è­¦æŠ¥æŒ‰è®¾å®šæ–¹å‘è§¦å‘", text_color=color.blue, bgcolor=color.new(color.blue, 90), text_size=size.small)