// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© gouge99

//@version=6
indicator("MT5 Indicator", overlay=true, max_labels_count = 500)

// äº¤æ˜“è®¾ç½®
tradingGroup = 'äº¤æ˜“è®¾ç½®'
resistanceStartTime = input.time(timestamp("2025-07-15 00:00:00"), "å‹åŠ›ä½å¼€å§‹æ—¶é—´", group=tradingGroup, tooltip="æ§åˆ¶å‹åŠ›ä½ä¿¡å·çš„èµ·å§‹æ—¶é—´ï¼Œçººé”¤çº¿ä¿¡å·ä¸å—æ­¤é™åˆ¶")
tradingDirection = input.string("åšå¤š", "äº¤æ˜“æ–¹å‘", options=["åšå¤š", "åšç©º"], group=tradingGroup)
positionSize = input.float(1.0, "å¼€ä»“æ•°é‡", minval=0.01, group=tradingGroup)
resistanceLevel = input.price(0.0, "é˜»åŠ›ä½ä»·æ ¼", group=tradingGroup, tooltip="å¤§äº0æ‰ç”Ÿæ•ˆ")
minBodySize = input.float(1.0, "æœ€å°å®ä½“é•¿åº¦", group=tradingGroup)
enableSpinningTopSignal = input.bool(true, "å¯ç”¨çººé”¤çº¿ä¿¡å·å¼€ä»“", group=tradingGroup)
enableSpinningTopPriceCheck = input.bool(true, "å¯ç”¨çººé”¤çº¿ä»·æ ¼æ¯”è¾ƒæ¡ä»¶", group=tradingGroup, tooltip="åšå¤šï¼šå¼€ç›˜ä»·>ç™½è‰²çººé”¤çº¿æ”¶ç›˜ä»·ï¼›åšç©ºï¼šå¼€ç›˜ä»·<é»‘è‰²çººé”¤çº¿æ”¶ç›˜ä»·")

// æ—¶é—´è®¾ç½®
timeGroup = 'æ—¶é—´è®¾ç½®'
timezone = input.string("GMT+8", "æ—¶åŒº", options=["GMT-12", "GMT-11", "GMT-10", "GMT-9", "GMT-8", "GMT-7", "GMT-6", "GMT-5", "GMT-4", "GMT-3", "GMT-2", "GMT-1", "GMT+0", "GMT+1", "GMT+2", "GMT+3", "GMT+4", "GMT+5", "GMT+6", "GMT+7", "GMT+8", "GMT+9", "GMT+10", "GMT+11", "GMT+12"], group=timeGroup)
enableSession1 = input.bool(true, "å¯ç”¨", group=timeGroup, inline="session1")
timeSession1 = input.session("0800-1200", "äº¤æ˜“æ—¶é—´æ®µ1", group=timeGroup, inline="session1")
enableSession2 = input.bool(true, "å¯ç”¨", group=timeGroup, inline="session2")
timeSession2 = input.session("1300-1700", "äº¤æ˜“æ—¶é—´æ®µ2", group=timeGroup, inline="session2")
enableSession3 = input.bool(true, "å¯ç”¨", group=timeGroup, inline="session3")
timeSession3 = input.session("1900-2300", "äº¤æ˜“æ—¶é—´æ®µ3", group=timeGroup, inline="session3")
enableSession4 = input.bool(true, "å¯ç”¨", group=timeGroup, inline="session4")
timeSession4 = input.session("0000-0600", "äº¤æ˜“æ—¶é—´æ®µ4", group=timeGroup, inline="session4")
enableSession5 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session5")
timeSession5 = input.session("0600-0800", "äº¤æ˜“æ—¶é—´æ®µ5", group=timeGroup, inline="session5")
enableSession6 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session6")
timeSession6 = input.session("1200-1300", "äº¤æ˜“æ—¶é—´æ®µ6", group=timeGroup, inline="session6")
enableSession7 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session7")
timeSession7 = input.session("1700-1900", "äº¤æ˜“æ—¶é—´æ®µ7", group=timeGroup, inline="session7")
enableSession8 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session8")
timeSession8 = input.session("2300-0000", "äº¤æ˜“æ—¶é—´æ®µ8", group=timeGroup, inline="session8")
enableSession9 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session9")
timeSession9 = input.session("0400-0600", "äº¤æ˜“æ—¶é—´æ®µ9", group=timeGroup, inline="session9")
enableSession10 = input.bool(false, "å¯ç”¨", group=timeGroup, inline="session10")
timeSession10 = input.session("2100-2300", "äº¤æ˜“æ—¶é—´æ®µ10", group=timeGroup, inline="session10")

// è¾“å…¥å‚æ•°è®¾ç½®
infoLabal = 'æ˜¾ç¤ºè®¾ç½®'
showSpinInfo = input.bool(false, title = 'æ˜¾ç¤ºçººé”¤çº¿', group = infoLabal)
label_color_neutral = input(color.gray, "Label Color Neutral", group = infoLabal)
showTimeBackground = input.bool(false, "æ˜¾ç¤ºæœ‰æ•ˆæ—¶é—´åŒºé—´èƒŒæ™¯", group = infoLabal)
showResistanceLevel = input.bool(true, "æ˜¾ç¤ºé˜»åŠ›ä½çº¿", group = infoLabal)
showStrategyNotice = input.bool(true, "æ˜¾ç¤ºæŒ‡æ ‡ä¿¡æ¯è¡¨æ ¼", group = infoLabal)

// çººé”¤çº¿è®¡ç®—
C_Len = 14 // ta.ema depth for bodyAvg
C_ShadowPercent = 5.0 // size of shadows
C_ShadowEqualsPercent = 100.0
C_DojiBodyPercent = 5.0
C_Factor = 2.0 // shows the number of times the shadow dominates the candlestick body

C_BodyHi = math.max(close, open)
C_BodyLo = math.min(close, open)
C_Body = C_BodyHi - C_BodyLo
C_BodyAvg = ta.ema(C_Body, C_Len)
C_SmallBody = C_Body < C_BodyAvg
C_LongBody = C_Body > C_BodyAvg
C_UpShadow = high - C_BodyHi
C_DnShadow = C_BodyLo - low
C_HasUpShadow = C_UpShadow > C_ShadowPercent / 100 * C_Body
C_HasDnShadow = C_DnShadow > C_ShadowPercent / 100 * C_Body
C_WhiteBody = open < close
C_BlackBody = open > close
C_Range = high-low
C_IsInsideBar = C_BodyHi[1] > C_BodyHi and C_BodyLo[1] < C_BodyLo
C_BodyMiddle = C_Body / 2 + C_BodyLo
C_ShadowEquals = C_UpShadow == C_DnShadow or (math.abs(C_UpShadow - C_DnShadow) / C_DnShadow * 100) < C_ShadowEqualsPercent and (math.abs(C_DnShadow - C_UpShadow) / C_UpShadow * 100) < C_ShadowEqualsPercent
C_IsDojiBody = C_Range > 0 and C_Body <= C_Range * C_DojiBodyPercent / 100
C_Doji = C_IsDojiBody and C_ShadowEquals

patternLabelPosLow = low - (ta.atr(30) * 0.6)
patternLabelPosHigh = high + (ta.atr(30) * 0.6)
C_SpinningTopWhiteNumberOfCandles = 1
C_SpinningTopWhitePercent = 34.0
C_IsSpinningTopWhite = C_DnShadow >= C_Range / 100 * C_SpinningTopWhitePercent and C_UpShadow >= C_Range / 100 * C_SpinningTopWhitePercent and not C_IsDojiBody
// ç™½è‰²çººé”¤çº¿
C_SpinningTopWhite = C_IsSpinningTopWhite and C_WhiteBody
if showSpinInfo and C_SpinningTopWhite
    var ttSpinningTopWhite = "Spinning Top White\nWhite spinning tops are candlestick lines that are small, green-bodied, and possess shadows (upper and lower) that end up exceeding the length of candle bodies. They often signal indecision between buyer and seller."
    label.new(bar_index, patternLabelPosLow, text="STW", style=label.style_label_up, color = label_color_neutral, textcolor=color.white, tooltip = ttSpinningTopWhite)

C_SpinningTopBlackNumberOfCandles = 1
C_SpinningTopBlackPercent = 34.0
C_IsSpinningTop = C_DnShadow >= C_Range / 100 * C_SpinningTopBlackPercent and C_UpShadow >= C_Range / 100 * C_SpinningTopBlackPercent and not C_IsDojiBody
// é»‘è‰²çººé”¤çº¿
C_SpinningTopBlack = C_IsSpinningTop and C_BlackBody
if showSpinInfo and C_SpinningTopBlack
    var ttSpinningTopBlack = "Spinning Top Black\nBlack spinning tops are candlestick lines that are small, red-bodied, and possess shadows (upper and lower) that end up exceeding the length of candle bodies. They often signal indecision."
    label.new(bar_index, patternLabelPosLow, text="STB", style=label.style_label_up, color = label_color_neutral, textcolor=color.white, tooltip = ttSpinningTopBlack)

bsSTW = ta.barssince(C_SpinningTopWhite)
bsTTB = ta.barssince(C_SpinningTopBlack)

// ä¿å­˜çººé”¤çº¿çš„æ”¶ç›˜ä»·
var float whiteSpinClosePrice = na
var float blackSpinClosePrice = na

if C_SpinningTopWhite
    whiteSpinClosePrice := close
if C_SpinningTopBlack
    blackSpinClosePrice := close

// æ—¶é—´æ¡ä»¶æ£€æŸ¥
isInTradingSession() =>
    session1 = enableSession1 ? time(timeframe.period, timeSession1, timezone) : na
    session2 = enableSession2 ? time(timeframe.period, timeSession2, timezone) : na
    session3 = enableSession3 ? time(timeframe.period, timeSession3, timezone) : na
    session4 = enableSession4 ? time(timeframe.period, timeSession4, timezone) : na
    session5 = enableSession5 ? time(timeframe.period, timeSession5, timezone) : na
    session6 = enableSession6 ? time(timeframe.period, timeSession6, timezone) : na
    session7 = enableSession7 ? time(timeframe.period, timeSession7, timezone) : na
    session8 = enableSession8 ? time(timeframe.period, timeSession8, timezone) : na
    session9 = enableSession9 ? time(timeframe.period, timeSession9, timezone) : na
    session10 = enableSession10 ? time(timeframe.period, timeSession10, timezone) : na
    not na(session1) or not na(session2) or not na(session3) or not na(session4) or not na(session5) or not na(session6) or not na(session7) or not na(session8) or not na(session9) or not na(session10)

bgcolor(showTimeBackground and isInTradingSession() ? color.new(color.blue, 95) : na)

// æ£€æŸ¥æ˜¯å¦åœ¨æ¯å°æ—¶çš„æœ€å10åˆ†é’Ÿ
isLastTenMinutes() =>
    currentMinute = minute(time)
    currentMinute >= 50

// æ—¶é—´æ¡ä»¶æ»¡è¶³ï¼ˆåˆ†åˆ«ä¸ºé˜»åŠ›ä½å’Œçººé”¤çº¿ï¼‰
resistanceTimeConditionMet = isInTradingSession() and not isLastTenMinutes() and time >= resistanceStartTime
spinningTimeConditionMet = isInTradingSession() and not isLastTenMinutes()

// çººé”¤çº¿çŠ¶æ€åˆ¤æ–­ï¼šä½¿ç”¨barssinceæ¥åˆ¤æ–­æœ€è¿‘çš„çººé”¤çº¿ç±»å‹
// åšå¤šï¼šç™½è‰²çººé”¤çº¿ä¹‹åï¼Œå‡ºç°é»‘è‰²çººé”¤çº¿ä¹‹å‰
// åšç©ºï¼šé»‘è‰²çººé”¤çº¿ä¹‹åï¼Œå‡ºç°ç™½è‰²çººé”¤çº¿ä¹‹å‰
isAfterWhiteSpinBeforeBlack = bsSTW < bsTTB or (bsSTW >= 0 and na(bsTTB))
isAfterBlackSpinBeforeWhite = bsTTB < bsSTW or (bsTTB >= 0 and na(bsSTW))

// åšå¤šæ¡ä»¶
longCondition1 = false
longCondition2 = false

var longCondition1Count = 0

// åšå¤šæ¡ä»¶1ï¼šå‹åŠ›ä½çªç ´, åªåšä¸€æ¬¡
if resistanceLevel > 0 and longCondition1Count == 0
    bodyLength = close - open
    hasNoLowerShadow = open == low
    bodyAboveResistance = open < resistanceLevel and (close - resistanceLevel) / (close - open) > 2/3
    longCondition1 := C_WhiteBody and bodyLength >= minBodySize and hasNoLowerShadow and bodyAboveResistance and resistanceTimeConditionMet
    if longCondition1
        longCondition1Count += 1

var waitSTBReset = false
if C_SpinningTopBlack
    waitSTBReset := true
// åšå¤šæ¡ä»¶2ï¼šçººé”¤çº¿åšå¤š
if isAfterWhiteSpinBeforeBlack and not C_SpinningTopBlack
    bodyLength = close - open
    hasNoLowerShadow = open == low
    priceCondition = enableSpinningTopPriceCheck ? (not na(whiteSpinClosePrice) and open > whiteSpinClosePrice) : true
    // ç™½è‰²çººé”¤çº¿åˆ°é»‘è‰²çººé”¤çº¿ä¹‹é—´åªåšä¸€æ¬¡
    longCondition2 := waitSTBReset and C_WhiteBody and bodyLength >= minBodySize and hasNoLowerShadow and spinningTimeConditionMet and priceCondition
    if longCondition2
        waitSTBReset := false

// åšç©ºæ¡ä»¶
shortCondition1 = false
shortCondition2 = false

var shortCondition1Count = 0

var waitSTWReset = false
if C_SpinningTopWhite
    waitSTWReset := true

// åšç©ºæ¡ä»¶1ï¼šå‹åŠ›ä½åšç©º, åªåšä¸€æ¬¡
if resistanceLevel > 0 and shortCondition1Count == 0
    bodyLength = open - close
    hasNoUpperShadow = open == high
    bodyBelowResistance = open > resistanceLevel and (close - resistanceLevel) / (close - open) > 2/3
    shortCondition1 := C_BlackBody and bodyLength >= minBodySize and hasNoUpperShadow and bodyBelowResistance and resistanceTimeConditionMet
    if shortCondition1
        shortCondition1Count += 1

// æ ¹æ®äº¤æ˜“æ–¹å‘è®¾ç½®æ‰§è¡Œäº¤æ˜“
canLong = tradingDirection == "åšå¤š"
canShort = tradingDirection == "åšç©º"

// ç»˜åˆ¶é˜»åŠ›ä½çº¿
var line resistanceLine = na
var label resistanceLabel = na
if showResistanceLevel and resistanceLevel > 0 and time >= resistanceStartTime and na(resistanceLine)
    resistanceLine := line.new(bar_index, resistanceLevel, bar_index + 1, resistanceLevel, 
                              color=color.red, style=line.style_dashed, width=2, extend=extend.right)
    resistanceLabel := label.new(bar_index, resistanceLevel, "é˜»åŠ›ä½: " + str.tostring(resistanceLevel), 
                                  style=label.style_arrowup, color=color.red, textcolor=color.white, size=size.normal)


// åšç©ºæ¡ä»¶2ï¼šçººé”¤çº¿åšç©º
if isAfterBlackSpinBeforeWhite and not C_SpinningTopWhite
    bodyLength = open - close
    hasNoUpperShadow = open == high
    priceCondition = enableSpinningTopPriceCheck ? (not na(blackSpinClosePrice) and open < blackSpinClosePrice) : true
    // é»‘è‰²çººé”¤çº¿åˆ°ç™½è‰²çººé”¤çº¿ä¹‹é—´åªåšä¸€æ¬¡
    shortCondition2 := waitSTWReset and C_BlackBody and bodyLength >= minBodySize and hasNoUpperShadow and spinningTimeConditionMet and priceCondition
    if shortCondition2
        waitSTWReset := false



// ä¿¡å·è§¦å‘
longSignal = canLong and (longCondition1 or (longCondition2 and enableSpinningTopSignal))
shortSignal = canShort and (shortCondition1 or (shortCondition2 and enableSpinningTopSignal))

// ç»˜åˆ¶ä¿¡å·ç®­å¤´
longResistanceSignal = canLong and longCondition1
longSpinningSignal = canLong and longCondition2 and enableSpinningTopSignal
shortResistanceSignal = canShort and shortCondition1
shortSpinningSignal = canShort and shortCondition2 and enableSpinningTopSignal

plotshape(longResistanceSignal, title="å‹åŠ›ä½åšå¤š", location=location.belowbar, color=color.green, style=shape.labelup, text="å‹", textcolor=color.white, size=size.small)
plotshape(longSpinningSignal, title="çººé”¤çº¿åšå¤š", location=location.belowbar, color=color.lime, style=shape.labelup, text="çºº", textcolor=color.white, size=size.small)
plotshape(shortResistanceSignal, title="å‹åŠ›ä½åšç©º", location=location.abovebar, color=color.red, style=shape.labeldown, text="å‹", textcolor=color.white, size=size.small)
plotshape(shortSpinningSignal, title="çººé”¤çº¿åšç©º", location=location.abovebar, color=color.maroon, style=shape.labeldown, text="çºº", textcolor=color.white, size=size.small)

// è­¦æŠ¥æ¡ä»¶
alertcondition(longResistanceSignal, title="å‹åŠ›ä½åšå¤š", message="long")
alertcondition(longSpinningSignal, title="çººé”¤çº¿åšå¤š", message="long")
alertcondition(shortResistanceSignal, title="å‹åŠ›ä½åšç©º", message="short")
alertcondition(shortSpinningSignal, title="çººé”¤çº¿åšç©º", message="short")

// æŒ‡æ ‡ä¿¡æ¯è¡¨æ ¼
var table indicatorTable = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)

if barstate.islast and showStrategyNotice
    // è¡¨æ ¼æ ‡é¢˜
    table.cell(indicatorTable, 0, 0, "æŒ‡æ ‡ä¿¡æ¯", text_color=color.black, bgcolor=color.gray, text_size=size.normal)
    table.cell(indicatorTable, 1, 0, "", text_color=color.black, bgcolor=color.gray)

    // å½“å‰çŠ¶æ€
    table.cell(indicatorTable, 0, 1, "å½“å‰çŠ¶æ€", text_color=color.black, bgcolor=color.white)
    statusText = "ç­‰å¾…ä¿¡å·ä¸­"
    table.cell(indicatorTable, 1, 1, statusText, text_color=color.blue, bgcolor=color.white)

    // äº¤æ˜“æ–¹å‘
    table.cell(indicatorTable, 0, 2, "äº¤æ˜“æ–¹å‘", text_color=color.black, bgcolor=color.white)
    directionColor = tradingDirection == "åšå¤š" ? color.green : color.red
    table.cell(indicatorTable, 1, 2, tradingDirection, text_color=directionColor, bgcolor=color.white)

    // ä½¿ç”¨è¯´æ˜
    table.cell(indicatorTable, 0, 3, "ä½¿ç”¨è¯´æ˜", text_color=color.black, bgcolor=color.new(color.blue, 90))
    noticeText = "ğŸ“ˆ ä¿¡å·å‡ºç°æ—¶ä¼šæ˜¾ç¤ºç®­å¤´\nâš ï¸ è¯·è®¾ç½®è­¦æŠ¥ä»¥æ¥æ”¶é€šçŸ¥"
    table.cell(indicatorTable, 1, 3, noticeText, text_color=color.blue, bgcolor=color.new(color.blue, 90), text_size=size.small)