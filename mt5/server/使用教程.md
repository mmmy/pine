# MT5交易服务器使用教程

## 📋 目录
1. [快速开始](#快速开始)
2. [基础交易操作](#基础交易操作)
3. [高级功能](#高级功能)
4. [时间区间控制](#时间区间控制)
5. [错误处理](#错误处理)
6. [开发调试](#开发调试)

## 🚀 快速开始

### 1. 启动服务器
```bash
cd mt5/server
python app.py
```

服务器启动后会显示：
```
MT5: CONNECTED - Account: 67424067
Trading hours manager initialized with 4 custom intervals
Server running on http://127.0.0.1:5000
```

### 2. 健康检查
```bash
curl http://127.0.0.1:5000/health
```

## 📈 基础交易操作

### 开仓操作

#### 开多仓（买入）
```bash
# 基础开多
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 XAUUSD"

# 指定仓位大小
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 XAUUSD 仓位=0.05"

# 带止损止盈
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 XAUUSD 仓位=0.1 止损=3350 止盈=3370"
```

#### 开空仓（卖出）
```bash
# 基础开空
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开空 EURUSD"

# 指定仓位大小
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开空 EURUSD 仓位=0.2"
```

### 平仓操作

#### 平多仓
```bash
# 平指定数量的多仓
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "平多 XAUUSD 仓位=0.05"

# 平所有多仓
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "平多 XAUUSD"
```

#### 平空仓
```bash
# 平指定数量的空仓
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "平空 EURUSD 仓位=0.1"

# 平所有空仓
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "平空 EURUSD"
```

#### 全平仓
```bash
# 平所有持仓
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "全平"

# 平指定品种的所有持仓
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "全平 XAUUSD"
```


## 🔧 高级功能

### JSON格式请求
```bash
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "action": "buy",
    "symbol": "XAUUSD",
    "volume": 0.05,
    "sl": 3350,
    "tp": 3370,
    "comment": "API交易"
  }'
```

### 修改持仓
```bash
# 修改止损止盈
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "action": "modify",
    "symbol": "XAUUSD",
    "ticket": 3824696857,
    "sl": 3355,
    "tp": 3375
  }'
```

### 查询操作
```bash
# 查看账户信息
curl http://127.0.0.1:5000/status

# 查看持仓
curl http://127.0.0.1:5000/positions

# 查看订单
curl http://127.0.0.1:5000/orders
```

## ⏰ 时间区间控制

### 开启时间区间
```bash
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开启时间区间"
```

### 时间段配置
系统预配置了4个时间段：
- **时段1**: 欧洲时段 (08:00-16:00 London)
- **时段2**: 美洲时段 (14:00-22:00 New York)
- **时段3**: 亚洲时段 (01:00-09:00 GMT+8)
- **时段4**: 亚洲时段 (13:00-15:00 GMT+8)

### 自定义时间段
编辑 `config.yaml` 文件：
```yaml
custom_intervals:
  interval5:
    name: "自定义时段5"
    start_time: "09:00"
    end_time: "17:00"
    timezone: "GMT+8"
    description: "工作时间"
```

## 🎯 常用交易品种

### 外汇
- **EURUSD** - 欧元/美元
- **GBPUSD** - 英镑/美元
- **USDJPY** - 美元/日元
- **AUDUSD** - 澳元/美元

### 贵金属
- **XAUUSD** - 黄金/美元
- **XAGUSD** - 白银/美元

### 原油
- **USOIL** - 美原油
- **UKOIL** - 布伦特原油

## ❌ 错误处理

### 常见错误及解决方案

#### 1. 交易时间限制
```json
{
  "error": "Trading not allowed at current time due to trading hours restrictions"
}
```
**解决方案**: 先执行 `开启时间区间` 命令

#### 2. 填充模式错误
```json
{
  "error": "Unsupported filling mode"
}
```
**解决方案**: 系统已自动修复，会自动选择最优填充模式

#### 3. 连接断开
```json
{
  "error": "Not connected to MT5"
}
```
**解决方案**: 系统具备自动重连功能，会自动尝试重连

#### 4. 自动交易禁用
```json
{
  "error": "AutoTrading disabled by client"
}
```
**解决方案**: 在MT5客户端启用自动交易

## 🛠️ 开发调试

### VSCode调试
1. 打开 `mt5/server` 目录
2. 按 `F5` 选择 "启动MT5服务器"
3. 设置断点进行调试

### 测试脚本
```bash
# 测试自动重连
python test_auto_reconnect.py

# 测试填充模式
python test_filling_mode.py

# 测试时区解析
python test_timezone.py
```

### 日志查看
服务器运行时会显示详细日志：
```
2025-07-25 13:52:18 - INFO - TRADE: BUY 0.05 XAUUSD @ 3355.97 - Success
2025-07-25 13:52:30 - INFO - TRADE: CLOSE 0.05 XAUUSD @ 3355.85 - Success
```

## 📊 响应格式

### 成功响应
```json
{
  "success": true,
  "message": "Trade executed successfully",
  "result": {
    "action": "buy",
    "symbol": "XAUUSD",
    "volume": 0.05,
    "price": 3355.97,
    "ticket": 3824696857,
    "timestamp": "2025-07-25T13:52:18.230604"
  }
}
```

### 错误响应
```json
{
  "success": false,
  "error": "Error message",
  "timestamp": "2025-07-25T13:52:18.230604"
}
```

## 🔐 安全配置

### API密钥（可选）
在 `config.yaml` 中配置：
```yaml
server:
  security:
    api_key: "your-secret-key"
```

使用时添加头部：
```bash
curl -X POST http://127.0.0.1:5000/webhook \
  -H "X-API-Key: your-secret-key" \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 XAUUSD"
```

## 📞 技术支持

### 常用命令速查
- **开多**: `开多 品种 [仓位=数量] [止损=价格] [止盈=价格]`
- **开空**: `开空 品种 [仓位=数量] [止损=价格] [止盈=价格]`
- **平多**: `平多 品种 [仓位=数量]`
- **平空**: `平空 品种 [仓位=数量]`
- **全平**: `全平 [品种]`
- **时间控制**: `开启时间区间`

### 获取帮助
- 查看日志了解详细错误信息
- 使用健康检查确认系统状态
- 参考示例文件 `TRADINGVIEW_WEBHOOK_EXAMPLES.md`

## 🔄 TradingView集成

### Webhook配置
1. 在TradingView策略中添加：
```pinescript
strategy.entry("Long", strategy.long, when=buy_condition)
strategy.close("Long", when=sell_condition)

// Webhook消息
if buy_condition
    alert("开多 {{ticker}} 仓位=0.1", alert.freq_once_per_bar)
if sell_condition
    alert("平多 {{ticker}}", alert.freq_once_per_bar)
```

2. 设置Webhook URL: `http://127.0.0.1:5000/webhook`

### Pine Script示例
```pinescript
//@version=5
strategy("MT5 Webhook Strategy", overlay=true)

// 策略参数
volume = input.float(0.1, "Position Size")
sl_percent = input.float(1.0, "Stop Loss %")
tp_percent = input.float(2.0, "Take Profit %")

// 交易信号
ma20 = ta.sma(close, 20)
ma50 = ta.sma(close, 50)

buy_signal = ta.crossover(ma20, ma50)
sell_signal = ta.crossunder(ma20, ma50)

// 执行交易
if buy_signal
    strategy.entry("Long", strategy.long)
    alert("开多 " + syminfo.ticker + " 仓位=" + str.tostring(volume), alert.freq_once_per_bar)

if sell_signal
    strategy.close("Long")
    alert("平多 " + syminfo.ticker, alert.freq_once_per_bar)
```

## 📱 PowerShell脚本示例

### 批量交易脚本
```powershell
# MT5交易脚本
$baseUrl = "http://127.0.0.1:5000/webhook"
$headers = @{"Content-Type" = "text/plain; charset=utf-8"}

# 开启时间区间
Invoke-RestMethod -Uri $baseUrl -Method POST -Body "开启时间区间" -Headers $headers

# 批量开仓
$symbols = @("XAUUSD", "EURUSD", "GBPUSD")
foreach ($symbol in $symbols) {
    $body = "开多 $symbol 仓位=0.05"
    try {
        $result = Invoke-RestMethod -Uri $baseUrl -Method POST -Body $body -Headers $headers
        Write-Host "✅ $symbol 开仓成功: $($result.result.ticket)"
    }
    catch {
        Write-Host "❌ $symbol 开仓失败: $($_.Exception.Message)"
    }
    Start-Sleep -Seconds 1
}
```

### 监控脚本
```powershell
# 账户监控脚本
function Get-AccountStatus {
    try {
        $status = Invoke-RestMethod -Uri "http://127.0.0.1:5000/health"
        $balance = $status.account_info.balance
        $equity = $status.account_info.equity
        $profit = $equity - $balance

        Write-Host "账户余额: $balance USD"
        Write-Host "账户净值: $equity USD"
        Write-Host "浮动盈亏: $profit USD"

        return $status.mt5_connected
    }
    catch {
        Write-Host "❌ 无法连接到服务器"
        return $false
    }
}

# 每30秒检查一次
while ($true) {
    Clear-Host
    Write-Host "=== MT5账户监控 ===" -ForegroundColor Green
    Write-Host "时间: $(Get-Date)" -ForegroundColor Yellow

    if (Get-AccountStatus) {
        Write-Host "✅ MT5连接正常" -ForegroundColor Green
    } else {
        Write-Host "❌ MT5连接异常" -ForegroundColor Red
    }

    Start-Sleep -Seconds 30
}
```

## 🎛️ 配置文件详解

### config.yaml完整配置
```yaml
# MT5连接配置
mt5:
  terminal_path: ""  # MT5终端路径（可选）

# 交易配置
trading:
  default_volume: 0.1      # 默认手数
  max_volume: 10.0         # 最大手数
  min_volume: 0.01         # 最小手数
  max_slippage: 3          # 最大滑点
  magic_number: 12345      # 魔术数字
  allowed_symbols: []      # 允许的交易品种（空=全部）

# 自定义时间段
custom_intervals:
  interval1:
    name: "欧洲时段"
    start_time: "08:00"
    end_time: "16:00"
    timezone: "Europe/London"
    description: "伦敦交易时间"

# 服务器配置
server:
  host: "127.0.0.1"
  port: 5000
  debug: false
  security:
    api_key: ""  # API密钥（可选）

# 日志配置
logging:
  level: "INFO"
  file: "mt5_server.log"
  console: true
```

## 🚨 风险管理

### 仓位管理
```bash
# 小仓位测试
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 XAUUSD 仓位=0.01"

# 分批建仓
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 XAUUSD 仓位=0.05 备注=第一批"

curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 XAUUSD 仓位=0.05 备注=第二批"
```

### 止损止盈设置
```bash
# 百分比止损
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 XAUUSD 仓位=0.1 止损百分比=1 止盈百分比=2"

# 固定点数止损
curl -X POST http://127.0.0.1:5000/webhook \
  -H "Content-Type: text/plain; charset=utf-8" \
  -d "开多 EURUSD 仓位=0.1 止损=1.0950 止盈=1.1050"
```

## 📈 性能优化

### 批量操作
```python
import requests
import json

# Python批量交易示例
def batch_trade():
    url = "http://127.0.0.1:5000/webhook"
    headers = {"Content-Type": "application/json"}

    trades = [
        {"action": "buy", "symbol": "XAUUSD", "volume": 0.05},
        {"action": "buy", "symbol": "EURUSD", "volume": 0.1},
        {"action": "buy", "symbol": "GBPUSD", "volume": 0.1}
    ]

    for trade in trades:
        try:
            response = requests.post(url, json=trade, headers=headers)
            result = response.json()
            if result.get("success"):
                print(f"✅ {trade['symbol']} 交易成功")
            else:
                print(f"❌ {trade['symbol']} 交易失败: {result.get('error')}")
        except Exception as e:
            print(f"❌ 请求失败: {e}")
```

## 🔍 故障排除

### 常见问题诊断

#### 1. 服务器无法启动
```bash
# 检查端口占用
netstat -ano | findstr :5000

# 检查Python环境
python --version
pip list | findstr MetaTrader5
```

#### 2. MT5连接失败
- 确保MT5客户端已登录
- 检查自动交易是否启用
- 验证账户权限

#### 3. 交易失败
```bash
# 查看详细错误
curl http://127.0.0.1:5000/health | python -m json.tool
```

### 日志分析
```bash
# 查看最新日志
tail -f mt5_server.log

# 搜索错误
grep "ERROR" mt5_server.log

# 搜索特定交易
grep "XAUUSD" mt5_server.log
```

---

🎉 **恭喜！您已掌握MT5交易服务器的完整使用方法！**

📚 **更多资源**:
- [API文档](TRADINGVIEW_WEBHOOK_EXAMPLES.md)
- [自动重连说明](AUTO_RECONNECT.md)
- [VSCode调试配置](.vscode/)
